<!DOCTYPE html>
<html>

<body>
    <img id="source" src="brain_slice.png" style="display:none;">
    <canvas id="canvas"></canvas>
    <div id="output"></div>
    <script>
        window.onload = function () {
            const img = document.getElementById('source');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            // Create masks
            const masks = {
                wm: ctx.createImageData(canvas.width, canvas.height),
                gm: ctx.createImageData(canvas.width, canvas.height),
                csf: ctx.createImageData(canvas.width, canvas.height),
                skull: ctx.createImageData(canvas.width, canvas.height)
            };

            // Thresholds (Estimated for T1-weighted image)
            // Background: < 15
            // CSF: 15 - 60
            // GM: 60 - 130
            // WM: > 130

            for (let i = 0; i < data.length; i += 4) {
                const brightness = data[i]; // R channel

                // Reset
                masks.wm.data[i + 3] = 0;
                masks.gm.data[i + 3] = 0;
                masks.csf.data[i + 3] = 0;
                masks.skull.data[i + 3] = 0;

                if (brightness > 15) {
                    if (brightness > 130) {
                        // WM
                        masks.wm.data[i + 3] = 255;
                    } else if (brightness > 60) {
                        // GM
                        masks.gm.data[i + 3] = 255;
                    } else {
                        // CSF
                        masks.csf.data[i + 3] = 255;
                    }
                }
                // Skull ignored for now or we can make a generic ring
            }

            const results = {};
            const exportMask = (name, imgData) => {
                ctx.putImageData(imgData, 0, 0);
                results[name] = canvas.toDataURL();
            };

            exportMask('wm', masks.wm);
            exportMask('gm', masks.gm);
            exportMask('csf', masks.csf);

            const div = document.createElement('div');
            div.id = 'json-output';
            div.innerText = JSON.stringify(results);
            document.body.appendChild(div);
        };
    </script>
</body>

</html>