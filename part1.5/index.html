<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Part 1.5: Spatial Encoding | MR Physics Simulation</title>
    <link rel="stylesheet" href="style.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body>
    <div class="app-container">
        <header class="main-header">
            <a href="../index.html" class="back-link">&larr; Home</a>
            <div class="header-titles">
                <h1>Spatial <span class="highlight">Encoding</span></h1>
                <p class="subtitle">How gradients encode position into signal phase - the foundation of MRI</p>
            </div>
        </header>

        <main class="main-content">
            <aside class="sidebar">
                <!-- Module Selection -->
                <div class="module-tabs">
                    <button class="module-tab active" data-module="A">A: Gradient Encoding</button>
                    <button class="module-tab" data-module="B">B: K-Space & Signal</button>
                </div>

                <!-- Module A: Gradient Encoding -->
                <div class="control-group module-controls" id="controls-A">
                    <h2>Gradient Controls</h2>

                    <div class="toggle-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="gx-toggle">
                            <span class="toggle-text">Frequency Gradient (G<sub>x</sub>)</span>
                        </label>
                        <div class="gradient-strength" id="gx-strength-container" style="display: none;">
                            <input type="range" id="gx-strength" min="1" max="10" value="5">
                            <span id="gx-strength-val">5</span>
                        </div>
                    </div>

                    <div class="toggle-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="gy-toggle">
                            <span class="toggle-text">Phase Gradient (G<sub>y</sub>)</span>
                        </label>
                        <div class="gradient-strength" id="gy-strength-container" style="display: none;">
                            <input type="range" id="gy-strength" min="1" max="10" value="5">
                            <span id="gy-strength-val">5</span>
                        </div>
                    </div>

                    <div class="control-row">
                        <label for="grid-size">Grid Size</label>
                        <select id="grid-size">
                            <option value="4" selected>4 × 4</option>
                            <option value="8">8 × 8</option>
                            <option value="12">12 × 12</option>
                            <option value="16">16 × 16</option>
                        </select>
                    </div>

                    <div class="toggle-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="random-signal-toggle">
                            <span class="toggle-text">Random signal per voxel</span>
                        </label>
                        <div class="gradient-strength" id="random-seed-container" style="display: none;">
                            <button id="reshuffle-btn" class="small-btn">Reshuffle</button>
                        </div>
                    </div>

                    <div class="toggle-group frame-toggle">
                        <label class="toggle-label">
                            <input type="checkbox" id="lab-frame-toggle">
                            <span class="toggle-text">Show Lab Frame (animate precession)</span>
                        </label>
                    </div>

                    <div class="info-panel">
                        <h4>What You're Seeing</h4>
                        <p id="encoding-explanation">
                            Without gradients, all spins have the same phase (pointing same direction).
                            Toggle gradients to see how they create position-dependent phase patterns.
                        </p>
                    </div>

                    <div class="equation-box">
                        <div id="equation-display">
                            \(\phi(x,y) = \gamma \cdot (G_x \cdot x + G_y \cdot y) \cdot t\)
                        </div>
                    </div>

                    <div class="info-panel secondary">
                        <h4>Key Difference</h4>
                        <p><strong>G<sub>x</sub> (Frequency)</strong>: ON during readout → phase accumulates continuously → oscillating signal<br>
                        <strong>G<sub>y</sub> (Phase)</strong>: ON before readout, then OFF → fixed phase imprint → constant magnitude</p>
                    </div>
                </div>

                <!-- Module B: K-Space & Signal -->
                <div class="control-group module-controls" id="controls-B" style="display: none;">
                    <h2>K-Space Encoding</h2>

                    <div class="info-panel" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);">
                        <h4 style="color: #ef4444;">k<sub>y</sub> = Phase Encoding Line</h4>
                        <p>Each TR acquires ONE line. G<sub>y</sub> sets which line.<br>
                        <em>Repeat for all k<sub>y</sub> values to fill k-space.</em></p>
                    </div>

                    <div class="control-row">
                        <label for="ky-position">k<sub>y</sub> Line (Phase Encode Step)</label>
                        <input type="range" id="ky-position" min="-8" max="8" value="0">
                        <span id="ky-val">0</span>
                    </div>

                    <div class="info-panel" style="background: rgba(168, 85, 247, 0.1); border-color: rgba(168, 85, 247, 0.3);">
                        <h4 style="color: #a855f7;">k<sub>x</sub> = Frequency (Readout)</h4>
                        <p>During readout, k<sub>x</sub> sweeps from -max to +max.<br>
                        <em>Slide to see signal at each k<sub>x</sub> point.</em></p>
                    </div>

                    <div class="control-row">
                        <label for="kx-position">k<sub>x</sub> Point (During Readout)</label>
                        <input type="range" id="kx-position" min="-8" max="8" value="0">
                        <span id="kx-val">0</span>
                    </div>

                    <div class="control-row">
                        <label for="grid-size-b">Grid Size</label>
                        <select id="grid-size-b">
                            <option value="4" selected>4 × 4</option>
                            <option value="8">8 × 8</option>
                            <option value="12">12 × 12</option>
                            <option value="16">16 × 16</option>
                        </select>
                    </div>

                    <div class="control-row">
                        <label for="object-select">Object</label>
                        <select id="object-select">
                            <option value="uniform">Uniform Square</option>
                            <option value="circle">Circle</option>
                            <option value="two-dots">Two Dots</option>
                            <option value="line-h">Horizontal Line</option>
                            <option value="line-v">Vertical Line</option>
                        </select>
                    </div>

                    <div class="toggle-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="random-signal-toggle-b">
                            <span class="toggle-text">Random signal per voxel</span>
                        </label>
                        <div class="gradient-strength" id="random-seed-container-b" style="display: none;">
                            <button id="reshuffle-btn-b" class="small-btn">Reshuffle</button>
                        </div>
                    </div>

                    <div class="equation-box">
                        \(S(k_x, k_y) = \sum_{x,y} \rho(x,y) \cdot e^{-i 2\pi (k_x x + k_y y)}\)
                    </div>

                    <div class="signal-display">
                        <h4>Signal = Sum of All Spins</h4>
                        <div class="signal-values">
                            <div class="signal-item">
                                <span class="signal-label">Real:</span>
                                <span class="signal-value" id="signal-real">0.00</span>
                            </div>
                            <div class="signal-item">
                                <span class="signal-label">Imag:</span>
                                <span class="signal-value" id="signal-imag">0.00</span>
                            </div>
                            <div class="signal-item">
                                <span class="signal-label">Mag:</span>
                                <span class="signal-value" id="signal-mag">0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="info-panel secondary">
                        <h4>Connection to Module A</h4>
                        <p>k<sub>x</sub> = Frequency encoding (G<sub>x</sub> × time)<br>
                        k<sub>y</sub> = Phase encoding (G<sub>y</sub> strength)</p>
                    </div>
                </div>

                <div class="sidebar-footer">
                    <p>Jinhee Jang, MD, PhD</p>
                    <p>Department of Radiology, Seoul St. Mary's Hospital</p>
                </div>
            </aside>

            <section class="visualization-area">
                <!-- Main visualization panels -->
                <div class="viz-grid">
                    <!-- 2D Spin Array -->
                    <div class="viz-panel" id="spin-panel">
                        <div class="panel-header">
                            <h2>2D Spin Array</h2>
                            <span class="panel-badge" id="spin-badge">Phase Pattern</span>
                        </div>
                        <div class="panel-content">
                            <canvas id="spin-canvas"></canvas>
                            <div class="axis-label axis-x">x (Frequency Encode Direction)</div>
                            <div class="axis-label axis-y">y (Phase Encode Direction)</div>
                        </div>
                    </div>

                    <!-- Phase Colorwheel / Legend -->
                    <div class="viz-panel small" id="legend-panel">
                        <div class="panel-header">
                            <h2>Phase Legend</h2>
                        </div>
                        <div class="panel-content centered">
                            <canvas id="legend-canvas"></canvas>
                        </div>
                    </div>

                    <!-- Signal / K-Space Panel -->
                    <div class="viz-panel" id="kspace-panel">
                        <div class="panel-header">
                            <h2 id="kspace-title">Signal Over Time</h2>
                            <span class="panel-badge" id="kspace-badge">Rotating Frame</span>
                        </div>
                        <div class="panel-content">
                            <canvas id="kspace-canvas"></canvas>
                        </div>
                    </div>

                    <!-- Object / Result -->
                    <div class="viz-panel small" id="object-panel">
                        <div class="panel-header">
                            <h2 id="object-title">Vector Sum</h2>
                        </div>
                        <div class="panel-content centered">
                            <canvas id="object-canvas"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="script.js"></script>
</body>

</html>
