<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSM Simulation - MR Physics</title>
    <link rel="stylesheet" href="style.css">
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <header class="main-header">
            <a href="../index.html" class="back-link">&larr; Home</a>
            <div class="header-titles">
                <h1><span class="highlight">QSM</span> Simulation</h1>
                <p class="subtitle">Explore Magnetic Susceptibility, Dipole Fields, and Inverse Problems</p>
            </div>
        </header>

        <main class="main-content">
            <aside class="sidebar">
                <div class="control-group">
                    <h2>Slice Selection</h2>
                    <label for="scan-plane">Scan Plane</label>
                    <select id="scan-plane">
                        <option value="axial" selected>Axial (XY)</option>
                        <option value="coronal">Coronal (XZ)</option>
                        <option value="sagittal">Sagittal (YZ)</option>
                    </select>
                </div>

                <div class="control-group">
                    <h2>Source Objects</h2>

                    <button id="add-random-btn" class="btn primary" style="font-size: 1.1rem; padding: 14px; margin-bottom: 15px;">+ Add Random Object</button>

                    <details style="margin-bottom: 10px;">
                        <summary style="cursor: pointer; color: var(--text-secondary); font-size: 0.85rem;">Custom Object Settings</summary>
                        <div style="margin-top: 10px;">
                            <label for="obj-shape">Shape</label>
                            <select id="obj-shape">
                                <option value="sphere">Sphere</option>
                                <option value="cube">Cube</option>
                                <option value="cylinder">Cylinder (Random Orientation)</option>
                                <option value="ellipsoid">Ellipsoid</option>
                            </select>

                            <label for="obj-size">Size (Radius/Half-Width)</label>
                            <input type="range" id="obj-size" min="3" max="30" step="1" value="12">
                            <span id="obj-size-val">12 px</span>

                            <label for="obj-chi">Susceptibility (\(\chi\))</label>
                            <input type="range" id="obj-chi" min="-1.0" max="1.0" step="0.1" value="1.0">
                            <span id="obj-chi-val">+1.0 ppm (Paramagnetic)</span>

                            <button id="add-object-btn" class="btn secondary" style="margin-top: 10px;">Add Custom Object</button>
                        </div>
                    </details>

                    <button id="clear-canvas" class="btn warning">Clear All Objects</button>
                </div>

                <div class="control-group">
                    <h2>B₀ Field Direction</h2>
                    <label for="b0-angle">B₀ Tilt Angle from Z-axis</label>
                    <input type="range" id="b0-angle" min="-90" max="90" step="5" value="0">
                    <span id="b0-angle-val">0° (Standard: B₀ ∥ Z)</span>
                    <em style="font-size: 0.65rem; opacity: 0.7; display: block; margin-top: 4px;">
                        0° = Standard (B₀ along S/I).<br>
                        ±55° = Magic angle.<br>
                        ±90° = B₀ perpendicular to Z.
                    </em>
                </div>

                <div class="control-group" id="recon-controls">
                    <h2>Reconstruction</h2>
                    <label for="reg-lambda">Regularization (\(\lambda\))</label>
                    <input type="range" id="reg-lambda" min="0" max="0.1" step="0.001" value="0.01">
                    <span id="reg-lambda-val">0.01</span>

                    <div style="margin-top: 10px;">
                        <label>Method:</label>
                        <select id="recon-method">
                            <option value="tikhonov">Tikhonov Regularization</option>
                            <option value="tkd">Truncated K-Space (TKD)</option>
                        </select>
                    </div>
                </div>

                <div class="control-group">
                    <div class="info-box" id="mode-info">
                        <h3>3D Volume Simulation</h3>
                        <p class="explanation-text">
                            <strong>Reference</strong>: Ground Truth \(\chi\) (3D volume).<br>
                            <strong>Phase</strong>: 3D dipole convolution \(\phi = \mathcal{F}^{-1}\{D \cdot \mathcal{F}\{\chi\}\}\).<br>
                            <strong>Recon</strong>: Regularized inverse \(\chi = \mathcal{F}^{-1}\{\frac{D}{D^2+\lambda} \cdot \mathcal{F}\{\phi\}\}\).<br>
                            <em style="font-size: 0.7rem; opacity: 0.8;">Full 3D dipole kernel: D(k) = 1/3 - k<sub>B₀</sub>²/|k|².</em>
                        </p>
                        <p class="explanation-text" style="margin-top: 8px; font-size: 0.65rem; opacity: 0.7;">
                            <strong>Note:</strong> Phase unwrapping, background field removal, and multi-echo combination are omitted.
                            See <a href="https://onlinelibrary.wiley.com/doi/full/10.1002/mrm.30006" target="_blank" style="color: var(--accent-color);">QSM Consensus Organization Committee, MRM 2024</a> for details.
                        </p>
                    </div>
                </div>

                <div class="sidebar-footer">
                    <p>Jinhee Jang, MD, PhD</p>
                    <p>Department of Radiology, Seoul St. Mary's Hospital</p>
                </div>
            </aside>

            <section class="visualization-area">
                <!-- Control Bar for Slice (Global) -->
                <div class="maps-control-bar">
                    <label for="slice-slider">Slice Position: <span id="slice-val">0</span> <span id="slice-axis-label">(Z)</span></label>
                    <input type="range" id="slice-slider" min="-128" max="128" value="0">
                </div>

                <!-- 2x2 Grid -->
                <div class="grid-2x2">
                    <!-- Top Left: 3D Phantom -->
                    <div class="panel-wrapper">
                        <div class="canvas-header">
                            <h2>3D Phantom</h2>
                            <select id="slice-texture-select" style="margin-left: 10px; font-size: 0.7rem; padding: 2px 5px;">
                                <option value="chi">Reference χ</option>
                                <option value="phase">Phase φ</option>
                                <option value="recon">Recon χ</option>
                            </select>
                        </div>
                        <div id="canvas-3d" class="panel-content"></div>
                        <p class="viewport-instruction">Left: Rotate | Right: Pan | Yellow: B₀ (↑Z)</p>
                    </div>

                    <!-- Top Right: Phase Image -->
                    <div class="panel-wrapper slice-view">
                        <div class="canvas-header">
                            <h2>Phase \(\phi\) [rad]</h2>
                        </div>
                        <div class="canvas-container panel-content">
                            <canvas id="simCanvasField" width="256" height="256"></canvas>
                            <span class="axis-label axis-x slice-axis-h">X</span>
                            <span class="axis-label axis-y slice-axis-v">Y</span>
                        </div>
                        <div class="colorbar-container">
                            <span class="cb-label">\(-\pi\)</span>
                            <div class="colorbar field-colorbar"></div>
                            <span class="cb-label">\(+\pi\)</span>
                        </div>
                    </div>

                    <!-- Bottom Left: Reference Chi -->
                    <div class="panel-wrapper slice-view">
                        <div class="canvas-header">
                            <h2>Reference \(\chi\) [ppm]</h2>
                        </div>
                        <div class="canvas-container panel-content">
                            <canvas id="simCanvasChi" width="256" height="256"></canvas>
                            <span class="axis-label axis-x slice-axis-h">X</span>
                            <span class="axis-label axis-y slice-axis-v">Y</span>
                        </div>
                        <div class="colorbar-container">
                            <span class="cb-label" id="chi-min-label">-1.0</span>
                            <div class="colorbar chi-colorbar"></div>
                            <span class="cb-label" id="chi-max-label">+1.0</span>
                        </div>
                    </div>

                    <!-- Bottom Right: Reconstruction -->
                    <div class="panel-wrapper slice-view">
                        <div class="canvas-header">
                            <h2>Reconstruction \(\chi_{recon}\) [ppm]</h2>
                        </div>
                        <div class="canvas-container panel-content">
                            <canvas id="simCanvasRecon" width="256" height="256"></canvas>
                            <span class="axis-label axis-x slice-axis-h">X</span>
                            <span class="axis-label axis-y slice-axis-v">Y</span>
                        </div>
                        <div class="colorbar-container">
                            <span class="cb-label" id="recon-min-label">-1.0</span>
                            <div class="colorbar chi-colorbar"></div>
                            <span class="cb-label" id="recon-max-label">+1.0</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="script.js"></script>
</body>

</html>